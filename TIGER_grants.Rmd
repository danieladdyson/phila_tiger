---
title: "Philadelphia lost a TIGER (grant) !"
author: "Daniel K. Addyson"
date: "August 29, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load in data & packages for analysis
```{r, echo=TRUE}
## Load in requisite packages
mods=c('data.table','raster','rgeos','ggplot2','ggthemes','ggmap','sp','tigris','leaflet')
invisible(lapply(mods, function(x) require(x,character.only=TRUE,quietly = TRUE)))

## Load in dataset. This link has the dataset.
tg=fread("https://www.transportation.gov/sites/dot.gov/files/docs/tiger_allUpdate.csv")

## note to self, tweet USDOT & tell them not to put spaces in column headings...
names(tg) 
setnames(tg, tg[,gsub("[^[:alnum:]]","",names(tg))])

## Create a column for year of award
tg[,Year := as.integer(gsub("[^0-9]","",Round))] 
## change award amount to numeric
tg[,Amount:=as.numeric(gsub("[\\$,]","",Amount))]
```

There's a lot of information in here about the types of projects getting awarded, the municipalities and states that won the awards, project descriptions, and lat/long data. so...

#### Where are projects getting funded?

I asked myself, where are projects getting funded? Since lat/long coordinates are available, you can just slap those points directly down on the good ole' USofA. I'm only showing the Contiguous 48 here -- projects were also awarded in HI, AK, & US Territories but the maps looked better with the explosions and I didn't have time to make cut-outs for our friends from afar.

To make things more interesting, I've colored each grant site by its logged award amount, to show the relative (financial) scale of magnitude between grants.

Please note, I've taken some of the code for ggmap from [Domino Labs](https://blog.dominodatalab.com/geographic-visualization-with-rs-ggmaps/). It made my life immediately easier

```{r, echo=TRUE}
pts=tg[,list(Year,Latitude,Longitude,Amount)]
## Hey, thanks Domino for posting this code snippet!
usa_center = as.numeric(geocode("United States"))
USAMap = get_googlemap(center=usa_center, scale=2, zoom=4)
##
ggmap(USAMap, extent="device"
      ,base_layer=ggplot(data=pts, aes(x=Longitude, y=Latitude,color=log(Amount))))+
  geom_point() +
  scale_colour_gradient(low = "white", high = "darkred") +
  theme(panel.margin = unit(.5, "lines"),
        plot.margin = unit(c(.5,.5,.5,.5),"lines"),
        legend.position='none') +
  facet_wrap(~Year)
```


#### Overlay points and county shapefile
```{r, echo=TRUE}
download.file('ftp://ftp2.census.gov/geo/tiger/TIGER2016/COUNTY/tl_2016_us_county.zip','cty_shp.zip') ## Download the Census county file
unzip('cty_shp.zip',exdir='cty_shp') # Create a folder
shp <- readOGR('C:/Users/A770213/Desktop/cty_shp',layer='tl_2016_us_county') # Census county shapefile

# turn TIGER lat/long data to spatial points
crs = shp@proj4string@projargs
pts=SpatialPointsDataFrame(coords=tg[,list(Longitude,Latitude)], data=tg, proj4string=CRS(crs) )

## double check to make sure the coordinates are aligned...
# plot(shp) # plot county shapefile
# plot(pts,add=TRUE,col='blue') # overlay grant sites point data

sj = data.table(over(pts,shp))
sj=cbind(tg,sj)
sj[,NAME:=as.character(NAME)]
cty_wins = as.data.table(sj[,table(NAME)])
wins_summary = cty_wins[,list(n_cty=.N),by=list(n_wins=N)]

ggplot(data=wins_summary,
       aes(sqrt(n_cty)))+
  geom_density()
  geom_bar(stat='identity')+
  labs(x='Number of Wins',
       y='Number of Counties')
```


```{r, echo=TRUE}
# Here's what we won
tg[,grep("*[Pp]hila*|Southeastern Pennsylvania Transportation Authority|*SEPTA*|Center City District",Applicant),list(Applicant,Year,ProjectType,ProjectName)]

# And a column to show whether we're us or not
tg[,Phila:=ifelse(grepl("*[Pp]hila*|Southeastern Pennsylvania Transportation Authority|*SEPTA*|Center City District",Applicant)==TRUE,1,0)]
```

```{r, echo=TRUE}
yr = tg[,.N,Year]
ggplot(data=yr,aes(x=as.character(Year),y=N)) + 
  geom_bar(stat='identity',fill='gray40') +
  geom_text(aes(y=N,label=N),vjust=1.5,color='white',fontface='bold')+
  labs(x="Funding Year"
       ,y="Number of Applications Awarded"
       ,title="Number of successful applications by funding year")
```

```{r, echo=TRUE}
tg_p=tg[Phila==1,] # Create indicator for Philadelphia
ggplot(data=tg,aes(x=as.character(Year),y=Amount/1e6,fill=as.character(Year))) + 
  geom_boxplot() +
  geom_point(data=tg_p,
             aes(x=as.character(Year),y=Amount/1e6), size=3,color="darkred")+
  geom_text(data=tg_p,
             aes(x=as.character(Year),y=Amount/1e6,label=paste0('$',round(Amount/1e6,1),'M')),vjust=-1,fontface=('bold.italic'))+
  scale_y_continuous(labels = scales::dollar_format(prefix="$",suffix="M"))+
  labs(x="Funding Year",
       y="Distribution of Amounts in Millions",
       title="Philly's award amounts vs. all other applicants")+
  guides(fill=FALSE)

# amt=tg[,list(amt=sum(Amount)/1e6),by=Year]
# ggplot(data=amt,aes(x=as.character(Year),y=amt)) + 
#   geom_bar(stat='identity',fill="darkgreen") +
#   scale_y_continuous(labels = scales::dollar_format(prefix="$",suffix="M"))+
#   geom_text(aes(vjust=1.5,label=paste0("$",round(amt,1))),color="white",fontface='bold')+
#   labs(x=("Year of Award"),
#        y=("Total Awards in Millions"),
#        title="Total Dollars Awarded by Year")
```

And, what kinds of projects are getting awarded? The Project Types themselves are a bit confusing. The list & cross-tabs below show that the project names were changed between years (e.g. Pedestrian/Bicycle). Others, such as Rail, Freight rail, & Passenger Rail are not quite so obvious. Maritime vs Port? And read some of the descriptions on Transit. That's a catchall for... everything.

```{r, echo=TRUE}
data.frame(sort(tg[!duplicated(ProjectType),ProjectType])) # Standardization anyone?
xtabs(~tg[,Year]+tg[,ProjectType]) # Look at the breaks in Bike/Pedestrian & Rail by years. They switched the names around.
```

The only way you can really spot differences in Project Types, is through the descriptions... ugh. Ultimately, I want to see what is going on with the City of Brotherly Looooove's proposals, so I'll regroup these using my best judgment (see judgment below). If there are any infrastructural/transpo/civil engineering types out there, feel free to disagree. Better yet, do a text mining analysis on the descriptions and help me reclassify them...

```{r, echo=TRUE}
tg[,ProjectType2:=ifelse(ProjectType %in% c('Bicycle-Pedestrian','Bicycle and Pedestrian'),'Bike/Ped',
                        ifelse(ProjectType %in% c('Freight Rail','Passenger Rail','Rail'),'Rail',
                               ifelse(ProjectType %in% c('Port','Maritime'),'Port/Maritime',
                                      ifelse(ProjectType %in% c('Planning','Regional Planning'),'Planning',
                                             ProjectType))))]
```


```{r, echo=TRUE}
tg_m1 = tg[,list(Amount=sum(Amount),N=.N),by=list(Year,ProjectType)]
tg_m2 = tg[,list(Amount=sum(Amount),N=.N),by=list(Year,ProjectType2)]
tg_m12 = tg[,list(Amount=sum(Amount),N=.N),by=Year]
lapply(list(tg_m1,tg_m2,tg_m12), function(x) setkeyv(x, 'Year'))
tg_m1=tg_m12[tg_m1]
tg_m2=tg_m12[tg_m2]
tg_m1[,':='(pct_amt=i.Amount/Amount,
            pct_N=i.N/N)]
tg_m2[,':='(pct_amt=i.Amount/Amount,
            pct_N=i.N/N)]


# tg_m = melt(tg,id.vars='Year',measure.vars=c('Amount','ProjectType','ProjectType2'))
ggplot(data=tg_m2,
       aes(x=as.character(Year),y=as.character(ProjectType2)))+
  geom_tile(aes(fill=pct_amt))+
  scale_fill_gradient(low = "white",high = "darkgreen")+
  labs(x="Year",y="Type of Project")
```